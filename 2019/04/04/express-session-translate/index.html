<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    
<link rel="stylesheet" href="/css/base.css">

    
<link rel="stylesheet" href="/css/screen-m.css" media="screen and (min-width: 480px)">

    
<link rel="stylesheet" href="/css/screen-l.css" media="screen and (min-width: 640px)">


    
    
    
    
        <title>ç¿»è¯‘ express-session ä½¿ç”¨æ–‡æ¡£ - Hui Li&#39;s Blog</title>
        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/highlight.css">

        
<link rel="stylesheet" href="/css/post.css">

    

    <!-- valine comment -->
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png">
    <link rel="manifest" href="/assets/favicons/site.webmanifest">
    <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/assets/favicons/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/assets/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <!-- the reason of using two layers of wrapper is to 
        avoid the scrollbar squeeze/overlap the content -->
    <div class="wrapper--header z-800">
        <div class="page-bounding">
            <header>
    <img class="site__logo" src="/assets/images/site-logo-mono.png" alt="blog icon">
    <nav class="header__nav">
        <h1 class="header__title">Hui Li</h1>
        <a class="nav__toggle" href="javascript:void(0);">
            <i class="icon__menu material-icons md-32">menu</i>
            <i class="icon__close material-icons md-32">close</i>
        </a>
        <menu class="nav__items">
            
                <span class="nav__item">
                    <a href="/">
                        <i class="material-icons item__icon">home</i>
                        <span class="item__text hover--underline">
                            Home
                        </span>
                    </a>
                </span>
            
                <span class="nav__item">
                    <a href="/tags">
                        <i class="material-icons item__icon">local_offer</i>
                        <span class="item__text hover--underline">
                            Tags
                        </span>
                    </a>
                </span>
            
                <span class="nav__item">
                    <a href="/search">
                        <i class="material-icons item__icon">search</i>
                        <span class="item__text hover--underline">
                            Search
                        </span>
                    </a>
                </span>
            
                <span class="nav__item">
                    <a href="/about">
                        <i class="material-icons item__icon">person</i>
                        <span class="item__text hover--underline">
                            About
                        </span>
                    </a>
                </span>
            
        </menu>
    </nav>
</header>
        </div>
    </div>
    <div class="wrapper--content">
        <div class="page-bounding">
            <!-- CONTENT -->
            <article>
    <div class="post__title">
        <h1 id="ç¿»è¯‘ express-session ä½¿ç”¨æ–‡æ¡£">
            ç¿»è¯‘ express-session ä½¿ç”¨æ–‡æ¡£
        </h1>
        <span class="post__meta">
            <i class="material-icons md-20">today</i>
            <span>2019-04-04</span>
        </span>
        <span class="post__meta leancloud_visitors"
            id="2019/04/04/express-session-translate/"
            data-flag-title="ç¿»è¯‘ express-session ä½¿ç”¨æ–‡æ¡£">
            <i class="material-icons md-20">visibility</i>
            <span class="leancloud-visitors-count">0</span>
        </span>
        
            <span class="post__meta">
                <i class="material-icons md-20">local_offer</i>
                
                    <a href="/tags/express-session/" class="tag tag--small hover--underline">#express-session</a>
                
            </span>
        
    </div>
    <div class="post__content">
        <blockquote>
<p><a href="https://www.npmjs.com/package/express-session" target="_blank" rel="noopener">æ–‡æ¡£åŸç½‘å€</a></p>
</blockquote>
<p>ä»¥ä¸‹ç¿»è¯‘æ­£æ–‡</p>
<h2 id="installation" id="Installation">Installation</h2>
<p>è¿™æ˜¯ä¸€ä¸ªé€šè¿‡ <a href="https://www.npmjs.com/" target="_blank" rel="noopener">npm registry</a> å¯ç”¨çš„ <a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node.js</a> æ¨¡å—ã€‚ä½¿ç”¨ä»¥ä¸‹ <code>npm install</code> å‘½ä»¤æ¥å®Œæˆå®‰è£…ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ npm install express-session<br></code></pre></td></tr></table></figure>
<h2 id="api" id="API">API</h2>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);<br></code></pre></td></tr></table></figure>
<h3 id="sessions(options)" id="sessions-options">sessions(options)</h3>
<p>ä½¿ç”¨ç»™å®šé€‰é¡¹åˆ›å»ºä¸€ä¸ª session ä¸­é—´ä»¶ã€‚<br>
<strong>æ³¨æ„</strong>ï¼šåªæœ‰ session ID æ˜¯ä¿å­˜åœ¨ cookie ä¸­ï¼ŒSession æ•°æ®æœ¬èº«å¹¶ä¸æ˜¯ã€‚Session æ•°æ®æ˜¯å­˜åœ¨æœåŠ¡ç«¯ã€‚<br>
<strong>æ³¨æ„</strong>ï¼šä»ç‰ˆæœ¬ 1.5.0 èµ·ï¼Œæœ¬æ¨¡å—ä¸å†éœ€è¦ <a href="https://www.npmjs.com/package/cookie-parser" target="_blank" rel="noopener">cookie-parser</a> ä¸­é—´ä»¶æ¥è¿è¡Œã€‚æœ¬æ¨¡å—ç°åœ¨ç›´æ¥åœ¨ req/res ä¸Šè¯»å†™ cookiesã€‚å½“æœ¬æ¨¡å—å’Œ cookie-parser çš„ <code>secret</code> ä¸ä¸€è‡´æ—¶ï¼Œä½¿ç”¨ cookie-parser å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚<br>
<strong>è­¦å‘Š</strong>ï¼šé»˜è®¤çš„æœåŠ¡ç«¯ session å­˜å‚¨ï¼ŒMemoryStoreï¼Œ<strong>ç‰¹æ„</strong>æ²¡æœ‰ä¸ºç”Ÿäº§ç¯å¢ƒè€Œè®¾è®¡ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œä¸ä¼šæ‰©å±•è¿‡å•ä¸ªè¿›ç¨‹ï¼Œè€Œä¸”æ˜¯ç”¨äºè°ƒè¯•å’Œå¼€å‘ã€‚<br>
å¯¹äºå­˜å‚¨åˆ—è¡¨ï¼Œè¯·æŸ¥çœ‹<a href="#compatible-session-stores">å…¼å®¹çš„ session å­˜å‚¨</a></p>
<h4 id="options" id="Options">Options</h4>
<p>express-session åœ¨ options å¯¹è±¡ä¸­æ¥æ”¶ä»¥ä¸‹å‚æ•°ï¼š</p>
<h5 id="cookie" id="cookie">cookie</h5>
<p>session ID cookie çš„è®¾ç½®å¯¹è±¡ã€‚é»˜è®¤å€¼ä¸º <code>{ path: '/', httpOnly: true, secure: false, maxAge: null }</code>.</p>
<p>ä¸‹åˆ—å‚æ•°å¯é€‰è®¾ç½®æ”¾å…¥ cookie å¯¹è±¡ã€‚</p>
<h6 id="cookie.domain" id="cookie-domain">cookie.domain</h6>
<p>ä¸º Set-Cookie å±æ€§æŒ‡å®š domainã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰è®¾ç½® domainï¼Œå¹¶ä¸”å¤§å¤šæ•°å®¢æˆ·ç«¯ä¼šå°† cookie è§†ä¸ºä»…åº”ç”¨äºå½“å‰ domainã€‚</p>
<h6 id="cookie.expires" id="cookie-expires">cookie.expires</h6>
<p>ä¸º Set-Cookie å±æ€§ä¸­çš„ Expires æŒ‡å®š Date å¯¹è±¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰è®¾ç½® expiresï¼Œå¤§å¤šæ•°å®¢æˆ·ç«¯ä¼šå°†è§†è¿™ä¸ªä¸º â€œéæŒä¹…åŒ– cookieâ€ å¹¶ä¸”åœ¨åƒé€€å‡ºæµè§ˆå™¨åº”ç”¨çš„åœºæ™¯ä¸‹åˆ é™¤è¯¥ cookieã€‚<br>
<strong>æ³¨æ„</strong>ï¼šå¦‚æœ options å¯¹è±¡ä¸­åŒæ—¶è®¾ç½®äº† expires å’Œ maxAgeï¼Œé‚£ä¹ˆå°†è¢«ç”¨åˆ°çš„æ˜¯åœ¨å¯¹è±¡ä¸­æœ€åä¸€ä¸ªè¢«å®šä¹‰çš„å±æ€§ã€‚<br>
<strong>æ³¨æ„</strong>ï¼šexpires é€‰é¡¹ä¸åº”è¯¥è¢«ç›´æ¥è®¾ç½®ï¼›è€Œåº”è¯¥åªä½¿ç”¨ maxAge é€‰é¡¹ã€‚</p>
<h6 id="cookie.httponly" id="cookie-httpOnly">cookie.httpOnly</h6>
<p>ä¸º Set-Cookie å±æ€§ä¸­çš„ HttpOnly æŒ‡å®š boolean å€¼ã€‚å½“ä¸ºçœŸå€¼ï¼ŒHttpOnly å±æ€§è¢«è®¾ç½®ï¼Œå¦åˆ™ä¸è¢«è®¾ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒHttpOnly å±æ€§æ˜¯è¢«è®¾ç½®çš„ã€‚<br>
<strong>æ³¨æ„</strong>ï¼šè®¾ç½®è¯¥å€¼ä¸º true çš„æ—¶å€™è¦å°å¿ƒï¼Œå› ä¸ºæœä»åè®®çš„å®¢æˆ·ç«¯ä¸ä¼šå…è®¸ JavaScript åœ¨ document.cookie ä¸­æŸ¥çœ‹ cookieã€‚</p>
<h6 id="cookie.maxage" id="cookie-maxAge">cookie.maxAge</h6>
<p>æŒ‡å®šå½“è®¡ç®— Set-Cookie å±æ€§ä¸­çš„ Expires æ—¶ä½¿ç”¨çš„ number ï¼ˆæ¯«ç§’ï¼‰å€¼ã€‚è¿™æ˜¯é€šè¿‡è·å–å½“å‰æœåŠ¡å™¨æ—¶é—´å¹¶å°† maxAge æ¯«ç§’æ•°åŠ å…¥å…¶ä¸­è®¡ç®— Expires æ—¥æœŸæ—¶é—´æ¥å®Œæˆçš„ã€‚é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰è®¾ç½® maxAgeã€‚<br>
<strong>æ³¨æ„</strong>ï¼šå¦‚æœ options å¯¹è±¡ä¸­åŒæ—¶è®¾ç½®äº† expires å’Œ maxAgeï¼Œé‚£ä¹ˆå°†è¢«ç”¨åˆ°çš„æ˜¯åœ¨å¯¹è±¡ä¸­æœ€åä¸€ä¸ªè¢«å®šä¹‰çš„å±æ€§ã€‚</p>
<h6 id="cookie.path" id="cookie-path">cookie.path</h6>
<p>ä¸º Set-Cookie å±æ€§æŒ‡å®š Path å€¼ã€‚é»˜è®¤æƒ…å†µä¸‹è¯¥å€¼è¢«è®¾ä¸º <code>'/'</code>ï¼Œä¹Ÿå°±æ˜¯ domain ä¸‹çš„æ ¹è·¯å¾„ã€‚</p>
<h6 id="cookie.samesite" id="cookie-sameSite">cookie.sameSite</h6>
<p>ä¸º Set-Cookie å±æ€§ä¸­çš„ SameSite æŒ‡å®š boolean æˆ–è€… string å€¼ã€‚å…¶ä¸­ï¼Œ</p>
<ul>
<li><code>true</code> ä¼šå°† SameSite å±æ€§è®¾ä¸º Strict ä»¥å®ç°ä¸¥æ ¼çš„ç›¸åŒç«™ç‚¹å¼ºåˆ¶ã€‚</li>
<li><code>false</code> ä¸ä¼š SameSite å±æ€§ã€‚</li>
<li><code>'lax'</code> ä¼šå°† SameSite å±æ€§è®¾ç½®ä¸º Lax ä»¥å®ç°å®½æ¾çš„ç›¸åŒç«™ç‚¹å¼ºåˆ¶ã€‚</li>
<li><code>'strict'</code> ä¼šå°† SameSite å±æ€§è®¾ç½®ä¸º Strict ä»¥å®ç°ä¸¥æ ¼çš„ç›¸åŒç«™ç‚¹å¼ºåˆ¶ã€‚</li>
</ul>
<p>å…³äºä¸åŒçš„å¼ºåˆ¶çº§åˆ«çš„æ›´å¤šä¿¡æ¯å¯ä»¥åœ¨ç»†åˆ™ä¸­æ‰¾åˆ°<a href="https://tools.ietf.org/html/draft-west-first-party-cookies-07#section-4.1.1" target="_blank" rel="noopener">https://tools.ietf.org/html/draft-west-first-party-cookies-07#section-4.1.1</a><br>
<strong>æ³¨æ„</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªè¿˜æœªè¢«å®Œå…¨æ ‡å‡†åŒ–çš„å±æ€§å¹¶ä¸”å°†æ¥å¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚è¿™æ„å‘³ç€è®¸å¤šå®¢æˆ·ç«¯å¯èƒ½å¿½ç•¥è¿™æ¡å±æ€§ç›´åˆ°å®ƒä»¬å®Œå…¨ç†è§£å®ƒä¸ºæ­¢ã€‚</p>
<h6 id="cookie.secure" id="cookie-secure">cookie.secure</h6>
<p>ä¸º Set-Cookie å±æ€§ä¸­çš„ Secure æŒ‡å®š boolean å€¼ã€‚å½“ä¸ºçœŸæ—¶ï¼ŒSecure å±æ€§è¢«è®¾ç½®å¦åˆ™æ²¡æœ‰è®¾ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ Secure å±æ€§æ²¡æœ‰è¢«è®¾ç½®ã€‚<br>
<strong>æ³¨æ„</strong>ï¼šå½“è®¾ç½®è¯¥å€¼ä¸º true çš„æ—¶å€™è¯·å°å¿ƒï¼Œå› ä¸ºå¦‚æœæµè§ˆå™¨æ²¡æœ‰å»ºç«‹ HTTPS è¿æ¥æœä»åè®®çš„å®¢æˆ·ç«¯å°†ä¸ä¼šå‘é€ cookie è¿”å›ç»™æœåŠ¡ç«¯ã€‚<br>
è¯·æ³¨æ„ secure: true æ˜¯æ¨èé€‰é¡¹ã€‚ç„¶è€Œï¼Œå®ƒéœ€è¦å¯ç”¨ HTTPS çš„ç½‘ç«™ï¼Œ ä¹Ÿå°±æ˜¯ HTTPS  æ˜¯ secure cookies æ‰€å¿…é¡»çš„ã€‚å¦‚æœ secure è¢«è®¾ç½®è€Œä½ é€šè¿‡ HTTP è®¿é—®ä½ çš„ç«™ç‚¹ï¼Œcookie å°†ä¸ä¼šè¢«è®¾ç½®ã€‚å¦‚æœä½ åœ¨ä»£ç†åä½¿ç”¨ node.js å¹¶ä¸”è®¾ç½® secure: trueï¼Œä½ éœ€è¦åœ¨ express ä¸­è®¾ç½® â€œtrust proxyâ€ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> app = express()<br>app.set(<span class="hljs-string">'trust proxy'</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// trust first proxy</span><br>app.use(session(&#123;<br>  secret: <span class="hljs-string">'keyboard cat'</span>,<br>  resave: <span class="hljs-literal">false</span>,<br>  saveUninitialized: <span class="hljs-literal">true</span>,<br>  cookie: &#123; <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span> &#125;<br>&#125;))<br></code></pre></td></tr></table></figure>
<p>ä¸ºäº†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ secure cookiesï¼ŒåŒæ—¶å…è®¸åœ¨å¼€å‘ç¯å¢ƒä¸­æµ‹è¯•ï¼Œä¸‹åˆ—æ˜¯åœ¨ express ä¸­åŸºäº <code>NODE_ENV</code> å¯ç”¨æ­¤è®¾ç½®çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> app = express()<br><span class="hljs-keyword">var</span> sess = &#123;<br>  secret: <span class="hljs-string">'keyboard cat'</span>,<br>  cookie: &#123;&#125;<br>&#125;<br> <br><span class="hljs-keyword">if</span> (app.get(<span class="hljs-string">'env'</span>) === <span class="hljs-string">'production'</span>) &#123;<br>  app.set(<span class="hljs-string">'trust proxy'</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// trust first proxy</span><br>  sess.cookie.secure = <span class="hljs-literal">true</span> <span class="hljs-comment">// serve secure cookies</span><br>&#125;<br> <br>app.use(session(sess))<br></code></pre></td></tr></table></figure>
<p>cookie.secure é€‰é¡¹ä¹Ÿå¯ä»¥è¢«è®¾ç½®æˆç‰¹æ®Šå€¼ â€œautoâ€ æ¥è®©è¿™ä¸ªè®¾ç½®è‡ªåŠ¨å’Œç¡®å®šçš„è¿æ¥çš„å®‰å…¨æ€§ç›¸åŒ¹é…ã€‚å¦‚æœç«™ç‚¹å¯ä»¥åŒæ—¶ç”¨åš HTTP å’Œ HTTPS è¯·å°å¿ƒä½¿ç”¨è¿™ä¸ªè®¾ç½®ï¼Œå› ä¸ºä¸€æ—¦ cookie çš„ HTTPS å±æ€§è¢«è®¾ç½®ï¼Œcookie ä¸ä¼šå†å¯¹ HTTP å¯è§ã€‚å½“ Express çš„ â€œtrust proxyâ€ è¢«æ­£ç¡®è®¾ç½®æ¥ç®€åŒ–å¼€å‘å’Œç”Ÿäº§é…ç½®çš„æ—¶å€™ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚</p>
<h5 id="genid" id="genid">genid</h5>
<p>è°ƒç”¨æ¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ session ID çš„å‡½æ•°ã€‚æä¾›ä¸€ä¸ªè¿”å› string ç±»å‹å¹¶å°†è¢«ç”¨æ¥ä½œä¸º session ID çš„å‡½æ•°ã€‚å½“ç”Ÿæˆ ID çš„æ—¶å€™å¦‚æœä½ æƒ³ç”¨ä¸€äº›é™„åŠ åˆ° req çš„å€¼ï¼Œè¯¥å‡½æ•°å·²ç»™å®š req ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚<br>
é»˜è®¤å€¼æ˜¯ä¸€ä¸ªä½¿ç”¨ <code>uid-safe</code> åº“æ¥ç”Ÿæˆ ID çš„å‡½æ•°ã€‚<br>
<strong>æ³¨æ„</strong>ï¼šè¯·å°å¿ƒç”Ÿæˆå”¯ä¸€çš„ ID ä»¥ä¾¿ä½ çš„ sessions ä¸ä¼šäº§ç”Ÿå†²çªã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">app.use(session(&#123;<br>  genid: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req</span>) </span>&#123;<br>    <span class="hljs-keyword">return</span> genuuid() <span class="hljs-comment">// use UUIDs for session IDs</span><br>  &#125;,<br>  secret: <span class="hljs-string">'keyboard cat'</span><br>&#125;))<br></code></pre></td></tr></table></figure>
<h5 id="name" id="name">name</h5>
<p>è®¾ç½®åœ¨ response ä¸­ï¼ˆå’Œä» request ä¸­è¯»å–ï¼‰çš„ session ID çš„ cookie çš„ nameã€‚<br>
é»˜è®¤å€¼ä¸º <code>&quot;connect.sid&quot;</code>ã€‚<br>
<strong>æ³¨æ„</strong>ï¼šå¦‚æœä½ æœ‰å¤šä¸ªè¿è¡Œåœ¨ç›¸åŒ hostnameï¼ˆåªæ˜¯åå­—ï¼Œä¹Ÿå°±æ˜¯ localhost æˆ–è€… 127.0.0.1ï¼›ä¸åŒçš„åè®®(scheme) å’Œ ç«¯å£(port) ä¸å‘½åä¸åŒçš„ä¸»æœºåï¼‰ä¸Šçš„åº”ç”¨ï¼Œé‚£ä¹ˆä½ éœ€è¦å°† session cookie å½¼æ­¤åˆ†å¼€ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯æ¯ä¸ªåº”ç”¨è®¾ç½®ä¸åŒçš„ nameã€‚</p>
<h5 id="proxy" id="proxy">proxy</h5>
<p>å½“è®¾ç½® secure cookies çš„æ—¶å€™ç›¸ä¿¡åå‘ä»£ç†ï¼ˆé€šè¿‡ <code>&quot;X-Forwarded-Proto&quot;</code> å¤´ï¼‰ã€‚<br>
é»˜è®¤å€¼ä¸º <code>undefined</code>ã€‚</p>
<ul>
<li><code>true</code> è¡¨ç¤º <code>&quot;X-Forwarded-Proto&quot;</code> å¤´å°†ä¼šè¢«ä½¿ç”¨ã€‚</li>
<li><code>false</code> è¡¨ç¤ºåªæœ‰å­˜åœ¨ç›´æ¥çš„ TLS/SSL è¿æ¥æ—¶æ‰ä¼šå¿½ç•¥æ‰€æœ‰å¤´å¹¶è®¤ä¸ºè¿æ¥æ˜¯å®‰å…¨çš„ã€‚</li>
<li><code>undefined</code> è¡¨ç¤ºä» express ä¸­ä½¿ç”¨ â€œtrust proxyâ€ã€‚</li>
</ul>
<h5 id="resave" id="resave">resave</h5>
<p>åŠæ—¶å›è¯åœ¨è¯·æ±‚æœŸé—´ä»æœªè¢«ä¿®æ”¹è¿‡ä¹Ÿå¼ºåˆ¶ session ä¿å­˜å› session å­˜å‚¨ã€‚æ ¹æ®ä½ çš„å­˜å‚¨è¿™å¯èƒ½æ˜¯å¿…é¡»çš„ï¼Œä½†æ˜¯è¿™ä¹Ÿå¯èƒ½åˆ›é€ ç«äº‰æ¡ä»¶å½“å®¢æˆ·ç«¯å‘é€ä¸¤ä¸ªå¹¶è¡Œè¯·æ±‚åˆ°ä½ çš„æœåŠ¡ç«¯å¹¶ä¸”å…¶ä¸­ä¸€ä¸ªè¯·æ±‚A å¯¹ session ä½œå‡ºçš„æ›´æ”¹å¯èƒ½ä¼šåœ¨å¦ä¸€ä¸ªè¯·æ±‚ B ç»“æŸæ—¶è¢«è¦†ç›–å³ä½¿è¯·æ±‚ B æ²¡æœ‰åšä»»ä½•æ›´æ”¹ï¼ˆè¿™ä¸ªè¡Œä¸ºå–å†³äºä½ ç”¨çš„ session å­˜å‚¨ï¼‰ã€‚<br>
é»˜è®¤å€¼ä¸º trueï¼Œä½†æ˜¯ä¸æ¨èä½¿ç”¨é»˜è®¤å€¼ï¼Œå› ä¸ºé»˜è®¤å€¼å°†æ¥ä¼šè¢«æ›´æ”¹ã€‚è¯·ç ”ç©¶æ­¤é¡¹è®¾ç½®å¹¶é€‰æ‹©é€‚åˆä½ çš„ç”¨ä¾‹çš„é€‰é¡¹ã€‚ä¸€èˆ¬æ¥è®²ï¼Œä½ ä¼šæƒ³é€‰æ‹© falseã€‚<br>
æˆ‘æ€ä¹ˆçŸ¥é“è¯¥è®¾ç½®å¯¹æˆ‘çš„ session å­˜å‚¨æ¥è®²æ˜¯ä¸æ˜¯å¿…é¡»çš„å‘¢ï¼Ÿæœ€å¥½çš„æ–¹æ³•æ˜¯æ£€æŸ¥ä½ çš„å­˜å‚¨çœ‹å®ƒæ˜¯å¦å®ç°äº† touch æ–¹æ³•ã€‚å¦‚æœå®ƒå®ç°äº†ï¼Œé‚£ä½ å¯ä»¥å®‰å…¨åœ°è®¾ç½® resave ä¸º falseã€‚å¦‚æœå®ƒæ²¡æœ‰å®ç° touch æ–¹æ³•è€Œä¸”ä½ çš„ store åœ¨å­˜å‚¨çš„ sessions ä¸­è®¾å®šçš„ expiration æ—¥æœŸï¼Œé‚£ä¹ˆä½ å¯èƒ½éœ€è¦è®¾ç½® resave: falseã€‚</p>
<h5 id="rolling" id="rolling">rolling</h5>
<p>å¼ºåˆ¶åœ¨æ¯æ¬¡å“åº”çš„æ—¶å€™è®¾ç½®ä¸€ä¸ª session æ ‡å¿—ç¬¦ cookieã€‚expiration é‡æ–°è¢«è®¾ç½®ä¸ºåˆå§‹çš„ maxAgeï¼Œé‡ç½® expiration å€’è®¡æ—¶ã€‚<br>
é»˜è®¤å€¼ä¸º falseã€‚<br>
<strong>æ³¨æ„</strong>ï¼šå½“è¯¥é€‰é¡¹è¢«è®¾ç½®ä¸º true ä½†æ˜¯ saveUninitialized é€‰é¡¹è¢«è®¾ç½®ä¸º falseï¼Œåˆ™ä¸ä¼šåœ¨å…·æœ‰æœªåˆå§‹åŒ–çš„ session å“åº”ä¸­è®¾ç½® cookieã€‚</p>
<h5 id="saveuninitialized" id="saveUninitialized">saveUninitialized</h5>
<p>å¼ºåˆ¶å°†æœªåˆå§‹åŒ–çš„ session ä¿å­˜å› storeã€‚å½“ä¸€ä¸ª session æ˜¯æ–°çš„ä½†æ˜¯è¿˜æœªè¢«ä¿®æ”¹æ—¶æˆ‘ä»¬è¯´ä»–æ˜¯æœªåˆå§‹åŒ–çš„ã€‚é€‰æ‹© false å€¼å¯¹å®ç°ç™»å½• session æ˜¯æœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒå‡å°‘äº†æœåŠ¡å™¨å­˜å‚¨çš„ç”¨é‡ï¼Œéµå®ˆäº†è®¾ç½® cookie å‰éœ€è¦è®¸å¯çš„è§„åˆ™ã€‚é€‰æ‹© false å€¼ä¹Ÿæœ‰åŠ©äºå®¢æˆ·ç«¯åœ¨æ²¡æœ‰å›è¯çš„æƒ…å†µä¸‹å‘å‡ºè¿‡ä¸ªå¹¶è¡Œè¯·æ±‚çš„ç«äº‰æ¡ä»¶ã€‚<br>
é»˜è®¤å€¼ä¸º trueï¼Œä½†æ˜¯ä¸æ¨èä½¿ç”¨é»˜è®¤å€¼ï¼Œå› ä¸ºé»˜è®¤å€¼å°†æ¥ä¼šè¢«æ›´æ”¹ã€‚è¯·ç ”ç©¶æ­¤é¡¹è®¾ç½®å¹¶é€‰æ‹©é€‚åˆä½ çš„ç”¨ä¾‹çš„é€‰é¡¹ã€‚<br>
<strong>æ³¨æ„</strong>ï¼šå¦‚æœä½ æ­£åœ¨ç»“åˆ PassportJS ä½¿ç”¨ Sessionï¼Œç”¨æˆ·é€šè¿‡èº«ä»½éªŒè¯åPassportJS å°†ä¸ºè¯¥ç”¨æˆ·åœ¨ session ä¸­æ·»åŠ ä¸€ä¸ªç©ºçš„ Passport å¯¹è±¡ï¼Œè¿™å°†ä¼šè§†ä¸ºå¯¹ session çš„ä¿®æ”¹ï¼Œå¯¼è‡´ session è¢«ä¿å­˜ã€‚<em>è¿™å·²ç»åœ¨ PassportJS 0.3.0 ä¸­è¢«ä¿®å¤ã€‚</em></p>
<h5 id="secret" id="secret">secret</h5>
<p><strong>å¿…è®¾é€‰é¡¹</strong><br>
è¿™æ˜¯ç”¨æ¥ç»™ session ID cookie ç­¾åçš„ secretã€‚è¿™å¯ä»¥æ˜¯å•ä¸ª secret çš„å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯å¤šä¸ª secret ç»„æˆçš„æ•°ç»„ã€‚å¦‚æœæä¾›äº†ä¸€ç»„ secretsï¼Œåªæœ‰ç¬¬ä¸€ä¸ªå…ƒç´ ä¼šè¢«ç”¨æ¥ç»™ session ID cookie ç­¾åï¼Œåœ¨éªŒè¯è¯·æ±‚ç­¾åçš„æ—¶å€™æ‰ä¼šè€ƒè™‘åˆ°æ‰€æœ‰å…ƒç´ ã€‚</p>
<h5 id="store" id="store">store</h5>
<p>session å­˜å‚¨å®ä¾‹ï¼Œé»˜è®¤ä¸ºä¸€ä¸ªæ–°çš„ MemoryStore å®ä¾‹ã€‚</p>
<h5 id="unset" id="unset">unset</h5>
<p>æ§åˆ¶å–æ¶ˆè®¾ç½® req.session çš„ç»“æœï¼ˆé€šè¿‡åˆ é™¤ï¼Œè®¾ä¸º nullï¼Œç­‰ç­‰ï¼‰ã€‚<br>
é»˜è®¤å€¼ä¸º <strong>'keepâ€™</strong></p>
<ul>
<li><code>'destroy'</code> è¡¨ç¤ºå½“å“åº”ç»“æŸçš„æ—¶å€™ session å°†ä¼šè¢«é”€æ¯ï¼ˆåˆ é™¤ï¼‰ã€‚</li>
<li><code>'keep'</code> è¡¨ç¤ºåœ¨ store ä¸­çš„ session ä¼šè¢«ä¿ç•™ï¼Œä½†æ˜¯åœ¨è¯·æ±‚æœŸé—´åšçš„ä¿®æ”¹å°†ä¼šè¢«å¿½ç•¥ä¸ä¼šè¢«ä¿å­˜ã€‚</li>
</ul>
<h3 id="req.session" id="req-session">req.session</h3>
<p>å­˜å‚¨æˆ–è€…è®¿é—® session æ•°æ®ï¼Œåªéœ€è¦ä½¿ç”¨è¯·æ±‚å±æ€§ req.sessionï¼Œè¯¥å±æ€§ï¼ˆé€šå¸¸ï¼‰ç”± store åºåˆ—åŒ–ä¸º sessionï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´åµŒå¥—å¯¹è±¡ä¹Ÿå¯ä»¥æ¥å—ã€‚ä¸‹é¢çš„ç¤ºä¾‹æ˜¯ä¸€ä¸ªåŸºäºç‰¹å®šç”¨æˆ·çš„è§†å›¾è®¡æ•°å™¨ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// Use the session middleware</span><br>app.use(session(&#123; <span class="hljs-attr">secret</span>: <span class="hljs-string">'keyboard cat'</span>, <span class="hljs-attr">cookie</span>: &#123; <span class="hljs-attr">maxAge</span>: <span class="hljs-number">60000</span> &#125;&#125;))<br> <br><span class="hljs-comment">// Access the session as req.session</span><br>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span> (req.session.views) &#123;<br>    req.session.views++<br>    res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>)<br>    res.write(<span class="hljs-string">'&lt;p&gt;views: '</span> + req.session.views + <span class="hljs-string">'&lt;/p&gt;'</span>)<br>    res.write(<span class="hljs-string">'&lt;p&gt;expires in: '</span> + (req.session.cookie.maxAge / <span class="hljs-number">1000</span>) + <span class="hljs-string">'s&lt;/p&gt;'</span>)<br>    res.end()<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    req.session.views = <span class="hljs-number">1</span><br>    res.end(<span class="hljs-string">'welcome to the session demo. refresh!'</span>)<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>
<h4 id="session.regenerate(callback)" id="Session-regenerate-callback">Session.regenerate(callback)</h4>
<p>è¦é‡æ–°ç”Ÿæˆ session åªéœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚å®Œæˆåä¸€ä¸ªæ–°çš„ SID å’Œ Session å®ä¾‹å°†ä¼šè¢«åˆå§‹åŒ–åœ¨ req.session å¹¶ä¸” callback ä¼šè¢«è°ƒç”¨ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">req.session.regenerate(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;<br>  <span class="hljs-comment">// will have a new session here</span><br>&#125;)<br></code></pre></td></tr></table></figure>
<h4 id="session.destroy(callback)" id="Session-destroy-callback">Session.destroy(callback)</h4>
<p>é”€æ¯ Session å¹¶å–æ¶ˆè®¾ç½® req.session å±æ€§ã€‚å®Œæˆåå°†è°ƒç”¨ callbackã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">req.session.destroy(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;<br>  <span class="hljs-comment">// cannot access session here</span><br>&#125;)<br></code></pre></td></tr></table></figure>
<h4 id="session.reload(callback)" id="Session-reload-callback">Session.reload(callback)</h4>
<p>ä» store é‡æ–°è½½å…¥ session æ•°æ®å¹¶é‡æ–°å¡«å…… req.session å¯¹è±¡ã€‚å®Œæˆåå°†è°ƒç”¨ callbackã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">req.session.reload(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;<br>  <span class="hljs-comment">// session updated</span><br>&#125;)<br></code></pre></td></tr></table></figure>
<h4 id="session.save(callback)" id="Session-save-callback">Session.save(callback)</h4>
<p>å°† session ä¿å­˜å› storeï¼Œç”¨å†…å­˜ä¸­çš„å†…å®¹æ›¿æ¢ store ä¸­çš„å†…å®¹ï¼ˆå°½ç®¡ store å¯èƒ½è¿˜ä¼šåšå…¶ä»–çš„äº‹æƒ…â€”å‚é˜… store çš„æ–‡æ¡£ä»¥äº†è§£å…¶ç¡®åˆ‡çš„è¡Œä¸ºï¼‰ã€‚<br>
å¦‚æœ session æ•°æ®è¢«æ”¹å˜äº†è¿™ä¸ªæ–¹æ³•ä¼šåœ¨ HTTP å“åº”çš„æœ«å°¾è‡ªåŠ¨è¢«è°ƒç”¨ï¼ˆå°½ç®¡è¿™ä¸ªè¡Œä¸ºå¯ä»¥è¢«ä¸­é—´ä»¶æ„é€ å™¨ä¸­çš„å¤šç§é€‰é¡¹æ‰€æ”¹å˜ï¼‰ã€‚å› æ­¤ï¼Œä¸€èˆ¬æ¥è®²è¿™ä¸ªæ–¹æ³•ä¸éœ€è¦è¢«æ‰‹åŠ¨è°ƒç”¨ã€‚<br>
å­˜åœ¨ä¸€äº›è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼šå¾ˆæœ‰ç”¨çš„æƒ…å†µï¼Œæ¯”å¦‚é‡å®šå‘ï¼Œé•¿æœŸè¯·æ±‚ï¼ˆlong-lived requestsï¼‰æˆ–ç€ WebSocketsã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">req.session.save(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;<br>  <span class="hljs-comment">// session saved</span><br>&#125;)<br></code></pre></td></tr></table></figure>
<h4 id="session.touch(callback)" id="Session-touch-callback">Session.touch(callback)</h4>
<p>æ›´æ–° .maxAge å±æ€§ã€‚ä¸€èˆ¬æ¥è®²è¿™ä¸ªæ–¹æ³•ä¸éœ€è¦è¢«è°ƒç”¨å› ä¸º session ä¸­é—´ä»¶ä¸ºä½ æ‰§è¡Œäº†è¿™ä¸ªæ“ä½œã€‚</p>
<h3 id="req.session.id" id="req-session-id">req.session.id</h3>
<p>æ¯ä¸€ä¸ª session éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„å”¯ä¸€ IDã€‚è¯¥å±æ€§æ˜¯ req.sessionID çš„åˆ«åè€Œä¸”æ— æ³•ä¿®æ”¹ã€‚è¯¥å±æ€§å·²è¢«æ·»åŠ ä»¥ä½¿ session ID å¯ä»¥ä» session å¯¹è±¡ä¸­è®¿é—®ã€‚</p>
<h3 id="req.session.cookie" id="req-session-cookie">req.session.cookie</h3>
<p>æ¯ä¸€ä¸ª session éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ cookie ä¸ä¹‹ä¼´éšã€‚è¿™å…è®¸ä½ æ›´æ”¹æ¯ä¸ªè®¿é—®è€…çš„ session cookieã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥è®¾ç½® req.session.cookie.expires ä¸º false æ¥ä½¿ cookie ä»…åœ¨ç”¨æˆ·-ä»£ç†çš„æŒç»­æ—¶é—´ä¸­ä¿ç•™ã€‚</p>
<h4 id="cookie.maxage-2" id="Cookie-maxAge">Cookie.maxAge</h4>
<p>req.session.cookie.maxAge å°†ä»¥æ¯«ç§’æ•°è¿”å›å‰©ä½™çš„æ—¶é—´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡æ–°åˆ†é…ä¸€ä¸ªæ–°å€¼æ¥é€‚å½“åœ°è°ƒæ•´ .expires å±æ€§ã€‚ä»¥ä¸‹ä»£ç æ˜¯ç­‰æ•ˆçš„ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> hour = <span class="hljs-number">3600000</span><br>req.session.cookie.expires = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-built_in">Date</span>.now() + hour)<br>req.session.cookie.maxAge = hour<br></code></pre></td></tr></table></figure>
<p>ä¾‹å¦‚å½“ maxAge è¢«è®¾ç½®ä¸º 60000ï¼ˆä¸€åˆ†é’Ÿï¼‰æ—¶ï¼Œä¸‰åç§’åå®ƒå°†è¿”å› 30000 çŸ¥é“å½“å‰çš„è¯·æ±‚å·²å®Œæˆï¼Œæ­¤æ—¶è°ƒç”¨ req.session.touch() å°†ä¼šé‡è®¾ req.session.maxAge ä¸ºå®ƒçš„åˆå§‹å€¼ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">req.session.cookie.maxAge <span class="hljs-comment">// =&gt; 30000</span><br></code></pre></td></tr></table></figure>
<h3 id="req.sessionid" id="req-sessionID">req.sessionID</h3>
<p>è¦æ‹¿åˆ°è½½å…¥çš„ session çš„ IDï¼Œè®¿é—®è¯·æ±‚çš„å±æ€§ req.sessionIDã€‚å½“ session è¢«è½½å…¥æˆ–è¢«åˆ›å»ºçš„æ—¶å€™è¿™ä»…æ˜¯ä¸€ä¸ªåªè¯»çš„å€¼ã€‚</p>
<h2 id="session-store-implementation" id="Session-Store-Implementation">Session Store Implementation</h2>
<p>æ¯ä¸€ä¸ª session store å¿…é¡»æ˜¯ä¸€ä¸ª EventEmitter å¹¶ä¸”å®ç°ç‰¹å®šçš„æ–¹æ³•ã€‚ä¸‹åˆ—çš„æ–¹æ³•æ˜¯å¿…éœ€ï¼Œæ¨èå’Œå¯é€‰çš„åˆ—è¡¨ã€‚</p>
<ul>
<li>å¿…éœ€çš„æ–¹æ³•æ˜¯æ­¤æ¨¡å—å°†ä¼šå§‹ç»ˆåœ¨ store ä¸­è°ƒç”¨çš„æ–¹æ³•ã€‚</li>
<li>æ¨èçš„æ–¹æ³•æ˜¯å¦‚æœå¯ç”¨æ­¤æ¨¡å—å°†ä¼šåœ¨ store ä¸­è°ƒç”¨çš„æ–¹æ³•ã€‚</li>
<li>å¯é€‰çš„æ–¹æ³•æ˜¯æ­¤æ¨¡å—æ ¹æœ¬ä¸ä¼šè°ƒç”¨çš„æ–¹æ³•</li>
</ul>
<p>æœ‰å…³ç¤ºä¾‹å®ç°è¯·æŸ¥çœ‹ <a href="http://github.com/visionmedia/connect-redis" target="_blank" rel="noopener">connect-redis</a> ä»“åº“ã€‚</p>
<h3 id="store.all(callback)" id="store-all-callback">store.all(callback)</h3>
<p><strong>å¯é€‰</strong><br>
è¯¥å¯é€‰æ–¹æ³•ç”¨äºä»¥æ•°ç»„å½¢å¼è·å– store ä¸­çš„æ‰€æœ‰ sessionã€‚å›è°ƒæ–¹æ³•åº”è¯¥ä½¿ç”¨ä¸º <code>callback(error, sessions)</code>ã€‚</p>
<h3 id="store.destroy(sid%2C-callback)" id="store-destroy-sid-callback">store.destroy(sid, callback)</h3>
<p><strong>å¿…éœ€</strong><br>
è¯¥å¿…éœ€æ–¹æ³•æ ¹æ®ç»™å®šçš„ session ID æ¥é”€æ¯ï¼ˆåˆ é™¤ï¼‰store ä¸­çš„ sessionã€‚sessionè¢«åˆ é™¤åå›è°ƒå‡½æ•°åº”è¯¥ä½¿ç”¨ä¸º <code>callback(error)</code>ã€‚</p>
<h3 id="store.clear(callback)" id="store-clear-callback">store.clear(callback)</h3>
<p><strong>å¯é€‰</strong><br>
è¯¥å¯é€‰æ–¹æ³•ç”¨äºåˆ é™¤ store ä¸­çš„æ‰€æœ‰ sessionã€‚store æ¸…ç©ºåå›è°ƒå‡½æ•°åº”è¯¥ä½¿ç”¨ä¸º <code>callback(error)</code>ã€‚</p>
<h3 id="store.length(callback)" id="store-length-callback">store.length(callback)</h3>
<p><strong>å¯é€‰</strong><br>
è¯¥å¯é€‰æ–¹æ³•ç”¨äºè·å– store ä¸­æ‰€æœ‰ session çš„ä¸ªæ•°ã€‚å›è°ƒå‡½æ•°åº”è¯¥ä½¿ç”¨ä¸º <code>callback(error, len)</code>ã€‚</p>
<h3 id="store.get(sid%2C-callback)" id="store-get-sid-callback">store.get(sid, callback)</h3>
<p><strong>å¿…éœ€</strong><br>
è¯¥å¿…éœ€æ–¹æ³•æ ¹æ®ç»™å®šçš„ session ID ä» store ä¸­è·å– sessionã€‚å›è°ƒå‡½æ•°åº”è¯¥ä½¿ç”¨ä¸º <code>callback(error, session)</code>ã€‚<br>
å¦‚æœæ‰¾åˆ° session å›è°ƒå‡½æ•°ä¸­çš„ session å‚æ•°åº”è¯¥ä¸ºä¸€ä¸ª session å¯¹è±¡ï¼Œå¦åˆ™å¦‚æœæ²¡æœ‰æ‰¾åˆ° sessionï¼ˆå¹¶ä¸”ä¹Ÿæ²¡æœ‰é”™è¯¯ï¼‰åº”è¯¥ä¸º null æˆ– undefinedã€‚å½“ <code>error.code === 'ENOENT'</code> è¡¨ç°ä¸º <code>callback(null, null)</code> ï¼Œè¿™æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</p>
<h3 id="store.set(sid%2C-session%2C-callback)" id="store-set-sid-session-callback">store.set(sid, session, callback)</h3>
<p><strong>å¿…éœ€</strong><br>
è¯¥å¿…éœ€æ–¹æ³•æ ¹æ®ç»™å®šçš„ session ID å’Œ session å¯¹è±¡å°† session å­˜å…¥ storeã€‚session å­˜å…¥ store åå›è°ƒå‡½æ•°åº”è¯¥ä½¿ç”¨ä¸º <code>callback(error)</code>ã€‚</p>
<h3 id="store.touch(sid%2C-session%2C-callback)" id="store-touch-sid-session-callback">store.touch(sid, session, callback)</h3>
<p><strong>æ¨è</strong><br>
è¯¥æ¨èæ–¹æ³•æ ¹æ®ç»™å®šçš„ session ID å’Œ session å¯¹è±¡ â€œè§¦ç¢°â€ ç»™å®šçš„ session å¯¹è±¡ã€‚session è¢« â€œè§¦ç¢°â€ åå›è°ƒå‡½æ•°åº”è¯¥ä½¿ç”¨ä¸º <code>callback(error)</code>ã€‚<br>
è¯¥æ–¹æ³•ä¸»è¦ç”¨äº store è‡ªåŠ¨åˆ é™¤ç©ºé—² sessionï¼Œå¹¶å°†æ­¤æ–¹æ³•ç”¨äºå‘ store å‘é€ç»™å®š session å¤„äºæ´»åŠ¨çŠ¶æ€çš„ä¿¡å·ï¼Œå¯èƒ½å›é‡ç½®ç©ºé—²è®¡æ—¶å™¨ã€‚</p>
<h2 id="compatible-session-stores" id="Compatible-Session-Stores">Compatible Session Stores</h2>
<p>ä¸‹åˆ—çš„æ¨¡å—æ˜¯å®ç°äº†ä¸€ä¸ªå’Œæœ¬æ¨¡å—å…¼å®¹çš„ session storeã€‚è¯·æå‡º PULL REQUEST æ¥æ·»åŠ å…¶ä»–çš„æ¨¡å— ğŸ˜ƒ<br>
æœ¬å¤„ä»…åˆ—å‡ºä¸¤å¤„ store å®ç°ï¼Œæ›´å¤šè¯·æŸ¥çœ‹<a href="https://www.npmjs.com/package/express-session#compatible-session-stores" target="_blank" rel="noopener">åŸæ–‡æ¡£</a><br>
<a href="https://www.npmjs.com/package/connect-db2" target="_blank" rel="noopener"><code>connect-db2</code></a>: ä¸€ä¸ªä½¿ç”¨ ibm_db æ¨¡å—å»ºæˆçš„åŸºäº IBM DB2 çš„ session storeã€‚<br>
<a href="https://www.npmjs.com/package/connect-mongo" target="_blank" rel="noopener"><code>connect-mongo</code></a>: ä¸€ä¸ªåŸºäº SQL Server çš„ session storeã€‚</p>
<h2 id="example" id="Example">Example</h2>
<p>ä¸€ä¸ªç®€å•ä½¿ç”¨ express-session æ¥ä¸ºç”¨æˆ·å­˜å‚¨é¡µé¢è®¿é—®çš„ä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)<br><span class="hljs-keyword">var</span> parseurl = <span class="hljs-built_in">require</span>(<span class="hljs-string">'parseurl'</span>)<br><span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>)<br> <br><span class="hljs-keyword">var</span> app = express()<br> <br>app.use(session(&#123;<br>  secret: <span class="hljs-string">'keyboard cat'</span>,<br>  resave: <span class="hljs-literal">false</span>,<br>  saveUninitialized: <span class="hljs-literal">true</span><br>&#125;))<br> <br>app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span> (!req.session.views) &#123;<br>    req.session.views = &#123;&#125;<br>  &#125;<br> <br>  <span class="hljs-comment">// get the url pathname</span><br>  <span class="hljs-keyword">var</span> pathname = parseurl(req).pathname<br> <br>  <span class="hljs-comment">// count the views</span><br>  req.session.views[pathname] = (req.session.views[pathname] || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span><br> <br>  next()<br>&#125;)<br> <br>app.get(<span class="hljs-string">'/foo'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.send(<span class="hljs-string">'you viewed this page '</span> + req.session.views[<span class="hljs-string">'/foo'</span>] + <span class="hljs-string">' times'</span>)<br>&#125;)<br> <br>app.get(<span class="hljs-string">'/bar'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  res.send(<span class="hljs-string">'you viewed this page '</span> + req.session.views[<span class="hljs-string">'/bar'</span>] + <span class="hljs-string">' times'</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>
<h2 id="license" id="License">License</h2>
<p><a href="https://github.com/expressjs/session/blob/HEAD/LICENSE" target="_blank" rel="noopener">MIT</a></p>
<h2 id="keywords" id="Keywords">Keywords</h2>
<p>none</p>

    </div>

    <!-- valine comments -->
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'NRWEWlMmlVAPPdVFXm5POWDg-gzGzoHsz',
            appKey: 'Xd0mldAOM82W7uRLnsSJpjOP',
            visitor: true
        })
    </script>
</article>


<!-- floating buttons: 1) scroll to top 2) show toc -->
<div class="floating-section z-400">
    <div class="floating-button hidden" id="toTop" onclick="window.location.href='#ç¿»è¯‘ express-session ä½¿ç”¨æ–‡æ¡£'">
        <i class="material-icons">keyboard_arrow_up</i>
    </div>
    <div class="floating-button" id="showToc">
        <i class="material-icons">format_list_numbered</i>
    </div>
</div>

<!-- MathJax Support -->

            <!-- FOOTER -->
            <footer>
    <span>Copyright Â© 2020 Hui Li.</span>
    <span><a class="hover--underline" href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">é„‚ICPå¤‡20014198å·</a>.</span>
</footer>
        </div>
    </div>

    <!-- OVERLAY -->
    <div class="overlay-container">
        <div class="backdrop"></div>
        
            <div class="wrapper--toc">
                <div class="page-bounding">
                    <h2>Table of Content</h2>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#installation"><span class="toc-number">1.</span> <span class="toc-text">Installation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#api"><span class="toc-number">2.</span> <span class="toc-text">API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sessions(options)"><span class="toc-number">2.1.</span> <span class="toc-text">sessions(options)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#options"><span class="toc-number">2.1.1.</span> <span class="toc-text">Options</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#req.session"><span class="toc-number">2.2.</span> <span class="toc-text">req.session</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#session.regenerate(callback)"><span class="toc-number">2.2.1.</span> <span class="toc-text">Session.regenerate(callback)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session.destroy(callback)"><span class="toc-number">2.2.2.</span> <span class="toc-text">Session.destroy(callback)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session.reload(callback)"><span class="toc-number">2.2.3.</span> <span class="toc-text">Session.reload(callback)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session.save(callback)"><span class="toc-number">2.2.4.</span> <span class="toc-text">Session.save(callback)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session.touch(callback)"><span class="toc-number">2.2.5.</span> <span class="toc-text">Session.touch(callback)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#req.session.id"><span class="toc-number">2.3.</span> <span class="toc-text">req.session.id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#req.session.cookie"><span class="toc-number">2.4.</span> <span class="toc-text">req.session.cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cookie.maxage-2"><span class="toc-number">2.4.1.</span> <span class="toc-text">Cookie.maxAge</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#req.sessionid"><span class="toc-number">2.5.</span> <span class="toc-text">req.sessionID</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session-store-implementation"><span class="toc-number">3.</span> <span class="toc-text">Session Store Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#store.all(callback)"><span class="toc-number">3.1.</span> <span class="toc-text">store.all(callback)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#store.destroy(sid%2C-callback)"><span class="toc-number">3.2.</span> <span class="toc-text">store.destroy(sid, callback)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#store.clear(callback)"><span class="toc-number">3.3.</span> <span class="toc-text">store.clear(callback)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#store.length(callback)"><span class="toc-number">3.4.</span> <span class="toc-text">store.length(callback)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#store.get(sid%2C-callback)"><span class="toc-number">3.5.</span> <span class="toc-text">store.get(sid, callback)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#store.set(sid%2C-session%2C-callback)"><span class="toc-number">3.6.</span> <span class="toc-text">store.set(sid, session, callback)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#store.touch(sid%2C-session%2C-callback)"><span class="toc-number">3.7.</span> <span class="toc-text">store.touch(sid, session, callback)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compatible-session-stores"><span class="toc-number">4.</span> <span class="toc-text">Compatible Session Stores</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#example"><span class="toc-number">5.</span> <span class="toc-text">Example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#license"><span class="toc-number">6.</span> <span class="toc-text">License</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keywords"><span class="toc-number">7.</span> <span class="toc-text">Keywords</span></a></li></ol>
                </div>
            </div>
        
    </div>

    <!-- javascript -->
    
<script src="/js/blog.js"></script>

    
        
<script src="/js/post.js"></script>

    

    

    <!-- BAIDU ANALYSIS -->
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?8c1d241f49c67b5e79ae300548e75894";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-158658232-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-158658232-1');
    </script>
    <!-- Tencent MTA -->
    <script>
        var _mtac = {};
        (function() {
            var mta = document.createElement("script");
            mta.src = "//pingjs.qq.com/h5/stats.js?v2.0.4";
            mta.setAttribute("name", "MTAH5");
            mta.setAttribute("sid", "500723158");
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(mta, s);
        })();
    </script>
</body>
</html>